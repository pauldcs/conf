#!/bin/bash

set -euo pipefail

readonly description="$(cat << __EOF__
    LLDB module auto-generated by $(basename "${0}") on $(date).
__EOF__
)"

function Usage()
{
    cat << EOF
Usage: $(basename "${0}") [option]
Options:
  --gen <NAME> <SOURCE> 
EOF
}

function Gen() {
    local source="${1}"
    local name="${2}"

    if [[ -r "${source}" && -f "${source}" ]]; then
        cat << __EOF__
#!/usr/bin/python3
import lldb

# Import this module by running:
#     (lldb) command script import ${name}.py
#     (lldb) ${name}

def ${name}(
        debugger,
        command,
        result,
        internal_dict
    ):
    """
${description}
    """

$(cat "${source}" | sed 's/^/    /')

def __lldb_init_module(
        debugger,
        internal_dict
    ):
    debugger.HandleCommand('command script add -f ${name}.${name} ${name}')
    print(' Installed: "${name}"')

__EOF__
else
    >&2 printf "error: ${source}: Invalid input file\n"
    exit 1
fi
}

if [[ "${#}" -lt 3 ]]
    then Usage;
    else
    {
        case "${1}" in
            --gen ) Gen "${2}" "${3}";;
            *     ) Usage && exit 1 ;;
        esac
    }
fi